<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Mensajer√≠a Web</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
  h1 { text-align: center; }
  label { display: block; margin-top: 15px; }
  input, button, select, textarea { width: 100%; padding: 8px; margin-top: 5px; }
  button { cursor: pointer; margin-top: 10px; }
  .contacto-item { border-bottom: 1px solid #ccc; padding: 5px 0; }
  .flex-row { display: flex; gap: 10px; }
  .flex-row > * { flex: 1; }
  .status { margin-top: 10px; color: green; }
  .error { color: red; }
</style>
</head>
<body>

<h1>Panel de Mensajer√≠a</h1>

<section>
  <h2>Contactos</h2>
  <button onclick="cargarContactos()">Cargar Contactos</button>
  <div id="lista-contactos"></div>
</section>

<section>
  <h2>Agregar Contacto</h2>
  <label>Nombre:
    <input type="text" id="nombreAgregar" />
  </label>
  <label>N√∫mero (con c√≥digo, ej +5491122334455):
    <input type="text" id="numeroAgregar" />
  </label>
  <button onclick="agregarContacto()">Agregar</button>
</section>

<section>
  <h2>Modificar Contacto</h2>
  <label>Nombre actual:
    <input type="text" id="nombreMod" />
  </label>
  <label>Nuevo nombre:
    <input type="text" id="nuevoNombreMod" />
  </label>
  <label>Nuevo n√∫mero:
    <input type="text" id="nuevoNumeroMod" />
  </label>
  <button onclick="modificarContacto()">Modificar</button>
</section>

<section>
  <h2>Eliminar Contacto</h2>
  <label>Nombre:
    <input type="text" id="nombreEliminar" />
  </label>
  <button onclick="eliminarContacto()">Eliminar</button>
</section>

<section>
  <h2>Enviar Mensaje</h2>
  <label>Nombre destinatario:
    <input type="text" id="nombreMensaje" />
  </label>
  <label>Mensaje:
    <textarea id="textoMensaje" rows="3"></textarea>
  </label>
  <button onclick="enviarMensaje()">Enviar</button>
</section>

<button onclick="window.location.href='/'">üè† Volver al Home</button>

<div id="status" class="status"></div>

<script>
async function cargarContactos() {
  const res = await fetch('/contactos');
  const contactos = await res.json();
  const lista = document.getElementById('lista-contactos');
  lista.innerHTML = '';
  for (const [nombre, numero] of Object.entries(contactos)) {
    const div = document.createElement('div');
    div.classList.add('contacto-item');
    div.textContent = `${nombre}: ${numero}`;
    lista.appendChild(div);
  }
  setStatus("Contactos cargados.");
}

async function agregarContacto() {
  const nombre = document.getElementById('nombreAgregar').value.trim();
  const numero = document.getElementById('numeroAgregar').value.trim();
  if (!nombre || !numero) {
    setStatus("Completa nombre y n√∫mero.", true);
    return;
  }
  const res = await fetch('/contactos', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ nombre, numero })
  });
  const data = await res.json();
  if (data.status === "ok") {
    setStatus("Contacto agregado.");
    cargarContactos();
    document.getElementById('nombreAgregar').value = '';
    document.getElementById('numeroAgregar').value = '';
  } else {
    setStatus("Error agregando contacto.", true);
  }
}

async function modificarContacto() {
  const nombre_actual = document.getElementById('nombreMod').value.trim();
  const nuevo_nombre = document.getElementById('nuevoNombreMod').value.trim();
  const nuevo_numero = document.getElementById('nuevoNumeroMod').value.trim();
  if (!nombre_actual || !nuevo_nombre || !nuevo_numero) {
    setStatus("Completa todos los campos para modificar.", true);
    return;
  }
  const res = await fetch('/contactos', {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ nombre_actual, nuevo_nombre, nuevo_numero })
  });
  const data = await res.json();
  if (data.status === "ok") {
    setStatus("Contacto modificado.");
    cargarContactos();
    document.getElementById('nombreMod').value = '';
    document.getElementById('nuevoNombreMod').value = '';
    document.getElementById('nuevoNumeroMod').value = '';
  } else {
    setStatus("Error modificando contacto.", true);
  }
}

async function eliminarContacto() {
  const nombre = document.getElementById('nombreEliminar').value.trim();
  if (!nombre) {
    setStatus("Completa el nombre para eliminar.", true);
    return;
  }
  const res = await fetch('/contactos', {
    method: 'DELETE',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ nombre })
  });
  const data = await res.json();
  if (data.status === "ok") {
    setStatus("Contacto eliminado.");
    cargarContactos();
    document.getElementById('nombreEliminar').value = '';
  } else {
    setStatus("Contacto no encontrado.", true);
  }
}

async function enviarMensaje() {
  const nombre = document.getElementById('nombreMensaje').value.trim();
  const mensaje = document.getElementById('textoMensaje').value.trim();
  if (!nombre || !mensaje) {
    setStatus("Completa destinatario y mensaje.", true);
    return;
  }
  const res = await fetch('/enviar', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({ nombre, mensaje })
  });
  const data = await res.json();
  if (data.status) {
    setStatus("Mensaje en proceso de env√≠o.");
    document.getElementById('nombreMensaje').value = '';
    document.getElementById('textoMensaje').value = '';
  } else {
    setStatus("Error enviando mensaje.", true);
  }
}

function setStatus(msg, error=false) {
  const statusDiv = document.getElementById('status');
  statusDiv.textContent = msg;
  statusDiv.className = error ? 'status error' : 'status';
}
</script>

</body>
</html>
